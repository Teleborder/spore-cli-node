#!/usr/bin/env node

var program = require('commander'),
    path = require('path'),
    readline = require('readline-sync'),
    colors = require('colors'),
    spawn = require('child_process').spawn,
    pkg = require('../package.json'),
    Spore = require('../lib/spore'),
    spore = new Spore();

colors.setTheme({
  silly: 'rainbow',
  input: 'grey',
  verbose: 'cyan',
  prompt: 'grey',
  info: 'green',
  data: 'grey',
  help: 'cyan',
  warn: 'yellow',
  debug: 'blue',
  error: 'red'
});

process.title = program._name = "spore";

program
  .version(pkg.version);

program
  .command('signup')
  .option("-e, --email <email>", "Email to sign up with")
  .option("-p, --password <password>", "Password to sign up with")
  .description("Create an Spore account")
  .action(function (options) {

    var email = options.email || readline.question("Email: ".prompt),
        password = options.password || readline.question("Password: ".prompt, { hideEchoBack: true });

    if(!email || !password) return error(new Error("Email and password are required."));

    spore.signup(email, password, function (err, user) {
      if(err) return error(err);

      info("Account created for " + user.email + ".");
    });
  });

program
  .command('login')
  .option("-e, --email <email>", "Email to log in with")
  .option("-p, --password <password>", "Password to log in with")
  .description("Log in to your Spore account")
  .action(function (options) {

    login(options.email, options.password, function (_, user) {
      info("Logged in as " + user.email + ".");
    });
  });

program
  .command('apps')
  .description("List all the apps you have access to")
  .action(function () {
    ensureLogin(function () {
      spore.api.listApps(function (err, apps) {
        if(err) return error(err);

        if(apps.length) {
          info(apps.join("\n"));
        } else {
          warn("No Apps found.");
          help("Create a new app with `spore new`.");
        }
      });
    });
  });

program
  .command('new [dir]')
  .alias('init [dir]')
  .option('-a, --app <appName>', "Name of the application")
  .description("Add a new app to Spore")
  .action(function (dir, options) {
    ensureLogin(function () {
      var appName = options.appName;
      dir = path.resolve(process.cwd(), dir || ".");

      if(!appName) {
        appName = spore.lookupName(dir);
      }

      spore.api.createApp(appName, function (err, app) {
        if(err.message === "App already exists") {
          error(err);
          help("Download your environment variables with `spore checkout`.");
          return;
        }

        if(err) return error(err);

        spore.writeDotSpore(app.name, dir, function (err) {
          if(err) return error(err);

          info(app.name + " created.");
        });
      });
    });
  });

program
  .command('checkout [dir]')
  .option('-a, --app <appName>', "Name of the application")
  .option('-e, --env <envName>', "Name of the environment")
  .description("Download a local copy of your environment variables")
  .action(function (dir, options) {
    ensureLogin(function () {
      dir = path.resolve(process.cwd(), dir || ".");

      spore.getAppAndEnv(dir, options.appName, options.envName, function (err, appName, envName) {
        if(err) return error(err);

        spore.writeDotSpore(appName, envName, dir, function (err) {
          if(err) return error(err);

          info("Environment variables for " + appName + "/" + envName + " checked out.");
        });
      });
    });
  });

program
  .command('set [KEY=value]')
  .option('-d, --directory <directory>', "Directory in which to look for a .spore file")
  .option('-a, --app <appName>', "Name of the application")
  .option('-e, --env <envName>', "Name of the environment")
  .description("Set an environment variable")
  .action(function (set, options) {
    if(set.indexOf('=') === -1) {
      return error(new Error("A set operation should be of the form ENV_VARIABLE=value"));
    }
    ensureLogin(function () {
      var key,
          value,
          dir = path.resolve(process.cwd(), options.directory || ".");

      key = set.substring(0, set.indexOf('='));
      value = set.substring(set.indexOf('=') + 1);

      spore.getAppAndEnv(dir, options.appName, options.envName, function (err, appName, envName) {
        if(err) return error(err);

        spore.api.set(appName, envName, key, value, function (err) {
          if(err) return error(err);

          info("`" + key + "` updated to `" + value + "` for " + appName + "/" + envName + ".");

          // only write the dot-spore back to this directory
          // if it's the right app and environment
          // (i.e. they weren't setting a variable for a different app)
          spore.getAppAndEnv(dir, null, null, function (err, defaultApp, defaultEnv) {
            if(err) return error(err);

            if(defaultApp === appName && defaultEnv === envName) {
              spore.writeDotSpore(appName, envName, dir, function (err) {
                info("local environment variables updated.");
              });
            } else {
              help("`" + key + "` was not updated locally because the local app/environment of " + defaultApp + "/" + defaultEnv + " didn't match the one you set.");
            }
          });
        });
      });
    });
  });

program
  .command('run [commands...]')
  .alias('exec [commands...]')
  .option('-d, --directory <directory>', "Directory in which to look for a .spore file")
  .option('-a, --app <appName>', "Name of the application")
  .option('-e, --env <envName>', "Name of the environment")
  .description("Run a command with Spore environment variables loaded")
  .action(function (cmds, options) {
    ensureLogin(function () {
      var dir = path.resolve(process.cwd(), options.directory || ".");

      spore.getAppAndEnv(dir, options.appName, options.envName, function (err, appName, envName) {
        if(err) return error(err);

        // TODO
        // Fallback to a local .spore so this command can run offline
        spore.getDotSpore(appName, envName, function (err, env) {
          if(err) return error(err);

          // use the current environment for defaults
          for(var p in process.env) {
            if(env[p] === undefined) {
              env[p] = process.env[p];
            }
          }

          var cmd = cmds.shift(),
              args = cmds;

          var child = spawn(cmd, args, { env: env });

          child.stdout.on('data', function (data) {
            process.stdout.write(data);
          });

          child.stderr.on('data', function (data) {
            process.stderr.write(data);
          });

          child.on('error', function (err) {
            error(err);
          });

          child.on('close', function (code) {
            if(code === 0) {
              info(cmd + " exited with code " + code);
            } else {
              error(new Error(cmd + " exited with code " + code));
            }
            process.exit(0);
          });
        });
      });
    });
  });

function ensureLogin(callback) {
  if(spore.getKey()) {
    return callback(null, true);
  }

  login(null, null, callback);
}

function login(email, password, callback) {
  email = email || readline.question("Email: ".prompt);
  password = password || readline.question("Password: ".prompt, { hideEchoBack: true });

  if(!email || !password) return error(new Error("Email and password are required."));

  spore.login(email, password, function (err, user) {
    if(err) error(err);

    callback(null, user);
  });
}

function error(err) {
  console.error(err.message.error);
}

function info(message) {
  console.info(message.info);
}

function help(message) {
  console.log(message.help);
}

function warn(message) {
  console.warn(message.warn);
}

if (!process.argv.slice(2).length) {
  program.help();
}

program.parse(process.argv);
